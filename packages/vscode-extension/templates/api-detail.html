<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0" />
    <title>Dynamic Sidebar</title>
    <link
      href="{{ styleUri }}"
      rel="stylesheet" />
    <!-- Prism ä¸»é¢˜ -->
    <link
      href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css"
      rel="stylesheet"
      id="prism-theme" />
    <!-- è¡Œå·æ’ä»¶ CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css"
      rel="stylesheet" />
  </head>

  <body>
    <div class="container">
      <div class="api-selector">
        <select
          id="api-select"
          class="api-select">
          <option value="">é€‰æ‹©APIæŸ¥çœ‹æ–‡æ¡£...</option>
          <option value="postAccountUser">POST /account/user/{version}</option>
          <option value="getUserProfile">GET /user/{id}/profile</option>
          <option value="updateProduct">PUT /products/{id}</option>
        </select>
      </div>

      <div
        class="api-container"
        id="api-container">
        <div class="no-content">è¯·ä»ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©ä¸€ä¸ªAPI</div>
      </div>

      <div class="footer">
        <button
          class="copy-btn"
          id="copy-btn">
          <svg
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path
              d="M8 4V16C8 16.5304 8.21071 17.0391 8.58579 17.4142C8.96086 17.7893 9.46957 18 10 18H18C18.5304 18 19.0391 17.7893 19.4142 17.4142C19.7893 17.0391 20 16.5304 20 16V7.5C20 7.10218 19.842 6.72064 19.5607 6.43934C19.2794 6.15804 18.8978 6 18.5 6H14C13.4696 6 12.9609 5.78929 12.5858 5.41421C12.2107 5.03914 12 4.53043 12 4V4C12 3.46957 11.7893 2.96086 11.4142 2.58579C11.0391 2.21071 10.5304 2 10 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V14C4 14.5304 4.21071 15.0391 4.58579 15.4142C4.96086 15.7893 5.46957 16 6 16H8"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
          å¤åˆ¶ç¤ºä¾‹ä»£ç 
        </button>
      </div>
    </div>
    <div class="header">
      <h1>Dynamic Sidebar</h1>
      <div class="controls">
        <button id="add-btn">Add Item</button>
        <button id="refresh-btn">Refresh</button>
      </div>
    </div>
    <div id="items-container">
      <p
        class="empty-message"
        id="empty-message">
        No items yet. Click "Add Item" to get started.
      </p>
      <ul id="items-list"></ul>
    </div>
    <!-- å¼•å…¥ JS -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script>
      // ===== æ•°æ®æœåŠ¡ =====
      const apiService = {
        // APIæ•°æ®
        apiData: {
          postAccountUser: {
            method: 'POST',
            summary: 'åˆ›å»ºç”¨æˆ·è´¦æˆ·',
            path: '/account/user/{version}',
            name: 'postAccountUser',
            responseName: 'UserBase',
            requestName: 'UserCreate',
            pathParameters:
              "{\n  /**\n   * generator version used by codegen engine\n   * [required]\n   */\n  version: 'V2' | 'V3'\n}",
            pathParametersComment:
              "{\n*   // generator version used by codegen engine\n*   // [required]\n*   version: 'V2' | 'V3'\n* }",
            responseComment:
              '{\n*   // [title] Name\n*   name?: string\n*   // è§’è‰²\n*   role?: 0 | 1\n*   // è¶…ç®¡ä¸‹è§’è‰²\n*   role_admin?: 0 | 1\n*   // [title] Phone\n*   phone?: string\n* }',
            requestComment:
              '{\n*   // [title] Account\n*   // [required]\n*   account: string\n*   // [title] Password\n*   // [required]\n*   password: string\n*   // [title] Name\n*   name?: string\n*   // è§’è‰²\n*   role?: 0 | 1\n*   // è¶…ç®¡ä¸‹è§’è‰²\n*   role_admin?: 0 | 1\n*   // [title] Phone\n*   phone?: string\n* }',
            defaultValue:
              "Apis.general.postAccountUser({\n  pathParams: {\n    version: 'V2'\n  },\n  data: {\n    account: '',\n    password: ''\n  }\n})"
          },
          getUserProfile: {
            method: 'GET',
            summary: 'è·å–ç”¨æˆ·ä¸ªäººèµ„æ–™',
            path: '/user/{id}/profile',
            name: 'getUserProfile',
            responseName: 'UserProfile',
            queryParameters: '{\n  /**\n   * æ˜¯å¦åŒ…å«è¯¦ç»†ä¿¡æ¯\n   */\n  detailed?: boolean\n}',
            pathParameters: '{\n  /**\n   * ç”¨æˆ·ID\n   * [required]\n   */\n  id: string\n}',
            defaultValue:
              "Apis.user.getProfile({\n  pathParams: {\n    id: '12345'\n  },\n  queryParams: {\n    detailed: true\n  }\n})"
          },
          updateProduct: {
            method: 'PUT',
            summary: 'æ›´æ–°äº§å“ä¿¡æ¯',
            path: '/products/{id}',
            name: 'updateProduct',
            responseName: 'Product',
            requestName: 'ProductUpdate',
            pathParameters: '{\n  /**\n   * äº§å“ID\n   * [required]\n   */\n  id: string\n}',
            requestComment:
              '{\n*   // äº§å“åç§°\n*   name?: string\n*   // äº§å“æè¿°\n*   description?: string\n*   // ä»·æ ¼\n*   price?: number\n*   // åº“å­˜æ•°é‡\n*   stock?: number\n*   // ä¸Šæ¶çŠ¶æ€\n*   published?: boolean\n* }',
            defaultValue:
              "Apis.products.update({\n  pathParams: {\n    id: 'prod-123'\n  },\n  data: {\n    name: 'New Product Name',\n    price: 29.99\n  }\n})"
          }
        },

        // è·å–æ‰€æœ‰API
        getAllApis() {
          return Object.keys(this.apiData);
        },

        // è·å–APIè¯¦æƒ…
        getApiDetails(apiKey) {
          return this.apiData[apiKey] || null;
        }
      };

      // ===== æ¸²æŸ“æœåŠ¡ =====
      const renderService = {
        // æ¸²æŸ“APIæ–‡æ¡£
        renderApiDocumentation(api) {
          if (!api) {
            return '<div class="no-content">è¯·ä»ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©ä¸€ä¸ªAPI</div>';
          }

          return `
                    <div class="api-header">
                        <div class="api-method">
                            <span class="method-tag ${api.method.toLowerCase()}">${api.method}</span>
                            <div class="api-url">${api.path}</div>
                        </div>
                        <div class="api-summary">${api.summary}</div>

                        <div class="api-info-row">
                            <div class="api-info-label">APIåç§°:</div>
                            <div class="api-info-value">${api.name}</div>
                        </div>
                        <div class="api-info-row">
                            <div class="api-info-label">å“åº”ä½“ç±»å‹:</div>
                            <div class="api-info-value">${api.responseName}</div>
                        </div>
                    </div>

                    <div class="tabs-container">
                        <div class="tabs">
                            <div class="tab active" data-tab="parameters">å‚æ•°</div>
                            <div class="tab" data-tab="response">å“åº”</div>
                            <div class="tab" data-tab="example">ç¤ºä¾‹</div>
                        </div>

                        <div class="tab-content active" id="parameters-content">
                            ${this.renderParametersSection(api)}
                        </div>

                        <div class="tab-content" id="response-content">
                            ${this.renderResponseSection(api)}
                        </div>

                        <div class="tab-content" id="example-content">
                            ${this.renderExampleSection(api)}
                        </div>
                    </div>
                `;
        },

        // æ¸²æŸ“å‚æ•°éƒ¨åˆ†
        renderParametersSection(api) {
          return `
                    <div class="section">
                        <div class="section-header">Path å‚æ•°</div>
                        ${this.renderParameterBlock(api.pathParametersComment, 'PathParameters')}
                    </div>

                    <div class="section">
                        <div class="section-header">Query å‚æ•°</div>
                        ${
                          api.queryParameters
                            ? this.renderParameterBlock(api.queryParameters, 'QueryParameters')
                            : '<div class="no-content">æ­¤æ¥å£æ²¡æœ‰æŸ¥è¯¢å‚æ•°</div>'
                        }
                    </div>

                    <div class="section">
                        <div class="section-header">è¯·æ±‚ä½“</div>
                        ${
                          api.requestName
                            ? `<pre class="line-numbers comment-block"><code class="language-typescript">${this.typeComment(api.requestComment, 'RequestBody')}</code></pre>`
                            : '<div class="no-content">æ­¤æ¥å£ä¸éœ€è¦è¯·æ±‚ä½“</div>'
                        }
                    </div>
                `;
        },

        // æ¸²æŸ“å“åº”éƒ¨åˆ†
        renderResponseSection(api) {
          return `
                    <div class="section">
                      <pre class="line-numbers comment-block"><code class="language-typescript">${this.typeComment(api.responseComment, 'ResponseBody')}</code></pre>
                    </div>
                `;
        },

        // æ¸²æŸ“ç¤ºä¾‹éƒ¨åˆ†
        renderExampleSection(api) {
          return `
                    <div class="section">
                        <div class="json-container">
                            <pre class="line-numbers comment-block"><code class="language-typescript">${api.defaultValue || '//æ— ç¤ºä¾‹ä»£ç '}</code></pre>
                        </div>
                    </div>
                `;
        },

        // æ¸²æŸ“å‚æ•°å—
        renderParameterBlock(parameters, name) {
          const content = this.typeComment(parameters, name);
          return content
            ? `<pre class="line-numbers comment-block"><code class="language-typescript">${content}</code></pre>`
            : '<div class="no-content">æ— å‚æ•°ä¿¡æ¯</div>';
        },

        // æ¸…ç†æ³¨é‡Šæ–‡æœ¬
        typeComment(comment, name) {
          if (!comment) {
            return '';
          }
          const pureComment = comment.replace(/\n\*/g, '\n').replace(/^\* /gm, '').trim();
          if (!pureComment) {
            return '';
          }
          return `type ${name ?? 'tsType'} = ${pureComment}`;
        }
      };
      class ClassWatcher {
        constructor(targetNode, classToWatch, classAddedCallback, classRemovedCallback) {
          this.targetNode = targetNode;
          this.classToWatch = classToWatch;
          this.classAddedCallback = classAddedCallback;
          this.classRemovedCallback = classRemovedCallback;
          this.observer = null;
          this.lastClassState = targetNode.classList.contains(this.classToWatch);

          this.init();
        }

        init() {
          this.observer = new MutationObserver(this.mutationCallback);
          this.observe();
          const currentClassState = this.targetNode?.classList.contains(this.classToWatch);
          if (currentClassState) {
            this.classAddedCallback();
          } else {
            this.classRemovedCallback();
          }
        }

        observe() {
          this.observer.observe(this.targetNode, { attributes: true });
        }

        disconnect() {
          this.observer.disconnect();
        }

        mutationCallback = mutationsList => {
          for (let mutation of mutationsList) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
              let currentClassState = mutation.target.classList.contains(this.classToWatch);
              if (this.lastClassState !== currentClassState) {
                this.lastClassState = currentClassState;
                if (currentClassState) {
                  this.classAddedCallback();
                } else {
                  this.classRemovedCallback();
                }
              }
            }
          }
        };
      }

      // ===== æ§åˆ¶å™¨ =====
      const controller = {
        // åˆå§‹åŒ–åº”ç”¨
        init() {
          this.cacheElements();
          this.setupEventListeners();
          this.renderApiSelector();
          this.wathThemeChange();
        },

        wathThemeChange() {
          const lightPrismUrl = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css';
          const darkPrismUrl = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css';
          const prismTheme = document.getElementById('prism-theme');
          const setDarkTheme = isDark => {
            if (isDark) {
              prismTheme.href = darkPrismUrl;
            } else {
              prismTheme.href = lightPrismUrl;
            }
          };
          const classWatcher = new ClassWatcher(
            document.body,
            'vscode-light',
            () => setDarkTheme(false),
            () => setDarkTheme(true)
          );
        },
        // ç¼“å­˜DOMå…ƒç´ 
        cacheElements() {
          this.elements = {
            apiSelect: document.getElementById('api-select'),
            apiContainer: document.getElementById('api-container'),
            copyBtn: document.getElementById('copy-btn')
          };
        },

        // è®¾ç½®äº‹ä»¶ç›‘å¬
        setupEventListeners() {
          this.elements.apiSelect.addEventListener('change', this.handleApiSelect.bind(this));
          this.elements.copyBtn.addEventListener('click', this.handleCopy.bind(this));
        },

        // æ¸²æŸ“APIé€‰æ‹©å™¨
        renderApiSelector() {
          const apis = apiService.getAllApis();
          apis.forEach(apiKey => {
            const api = apiService.getApiDetails(apiKey);
            const option = document.createElement('option');
            option.value = apiKey;
            option.textContent = `${api.method} ${api.path}`;
            this.elements.apiSelect.appendChild(option);
          });
        },

        // å¤„ç†APIé€‰æ‹©
        handleApiSelect() {
          const apiKey = this.elements.apiSelect.value;
          const api = apiService.getApiDetails(apiKey);
          this.elements.apiContainer.innerHTML = renderService.renderApiDocumentation(api);
          this.setupTabs();
        },

        // è®¾ç½®æ ‡ç­¾é¡µäº¤äº’
        setupTabs() {
          const tabs = this.elements.apiContainer.querySelectorAll('.tab');

          tabs.forEach(tab => {
            tab.addEventListener('click', () => {
              // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
              tabs.forEach(t => t.classList.remove('active'));

              // éšè—æ‰€æœ‰å†…å®¹
              const contents = this.elements.apiContainer.querySelectorAll('.tab-content');
              contents.forEach(c => c.classList.remove('active'));

              // æ¿€æ´»å½“å‰æ ‡ç­¾
              tab.classList.add('active');
              const tabId = tab.getAttribute('data-tab');
              document.getElementById(`${tabId}-content`).classList.add('active');
            });
          });
          Prism.highlightAll();
        },

        // å¤„ç†å¤åˆ¶æ“ä½œ
        handleCopy() {
          const codeBlock = this.elements.apiContainer.querySelector('.json-container pre code');
          if (codeBlock) {
            navigator.clipboard.writeText(codeBlock.innerText).then(() => {
              const originalContent = this.elements.copyBtn.innerHTML;
              this.elements.copyBtn.innerHTML = `
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 16.1719L19.5938 5.57812L21 6.98438L9 18.9844L3.42187 13.4062L4.82812 12L9 16.1719Z" fill="currentColor"/>
                            </svg>
                            å·²å¤åˆ¶
                        `;

              setTimeout(() => {
                this.elements.copyBtn.innerHTML = originalContent;
              }, 2000);
            });
          }
        }
      };

      // åˆå§‹åŒ–åº”ç”¨
      document.addEventListener('DOMContentLoaded', () => controller.init());

      const vscode = acquireVsCodeApi();

      // é€šçŸ¥æ‰©å±•Webviewå·²å‡†å¤‡å¥½
      window.addEventListener('load', () => {
        vscode.postMessage({ type: 'webview-ready' });
      });
      // å¤„ç†æŒ‰é’®ç‚¹å‡»
      document.getElementById('add-btn').addEventListener('click', () => {
        vscode.postMessage({ type: 'addItem' });
      });

      document.getElementById('refresh-btn').addEventListener('click', () => {
        vscode.postMessage({ type: 'refresh' });
      });

      // å¤„ç†æ¥è‡ªæ‰©å±•çš„æ¶ˆæ¯
      window.addEventListener('message', event => {
        const message = event.data;
        switch (message.type) {
          case 'updateData':
            updateItemsList(message.data);
            break;
        }
      });

      function updateItemsList(items) {
        const list = document.getElementById('items-list');
        const emptyMsg = document.getElementById('empty-message');

        if (items.length === 0) {
          list.innerHTML = '';
          emptyMsg.style.display = 'block';
          return;
        }

        emptyMsg.style.display = 'none';
        list.innerHTML = '';

        items.forEach(item => {
          const li = document.createElement('li');
          li.className = 'item';
          li.innerHTML = `
                  <span class="item-icon">ğŸ“„</span>
                  <span class="item-label">${item.label}</span>
                  <span class="item-id">#${item.id.slice(0, 6)}</span>
              `;
          list.appendChild(li);
        });
      }
    </script>
  </body>
</html>
